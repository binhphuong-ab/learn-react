# KaizenNote Technical Reference (2030-07-02-26)

## 1) System Overview

KaizenNote is a full-stack Next.js App Router application for weekly time-block planning, activity/project tracking, daily reflections, and reporting.

Core characteristics:

- Frontend and backend are in one Next.js app (`app/` + Route Handlers under `app/api/*`).
- MongoDB Atlas is the primary datastore.
- Authentication is custom username/password + JWT session cookie.
- UI is mostly in one client component: `components/planner/planner-app.tsx`.

---

## 2) Tech Stack

### Runtime and framework

- Next.js `16.1.6` (App Router)
- React `19.2.3`
- TypeScript `5`
- Node.js `18+` recommended

### Styling/UI

- Tailwind CSS v4
- shadcn/ui setup (utility and theme scaffolding)
- lucide-react icon package installed

### Backend and validation

- MongoDB Node Driver `7.1.0`
- `zod` for request validation
- `bcryptjs` for password hashing
- `jose` for JWT signing/verification

---

## 3) Project Structure

### Main app routes

- `app/page.tsx`: redirects to `/planner` if logged in, otherwise `/login`
- `app/login/page.tsx`: login UI
- `app/register/page.tsx`: register UI
- `app/planner/page.tsx`: protected planner page

### Main client app

- `components/planner/planner-app.tsx`: planner/dashboard/settings/profile UI and most client-side state logic

### API routes

- `app/api/auth/*`
- `app/api/activity-types/*`
- `app/api/projects/*`
- `app/api/tasks/*`
- `app/api/reflections/*`
- `app/api/reports/*`

### Core server libraries

- `lib/mongodb.ts`: DB connection + index initialization
- `lib/auth.ts`: JWT + cookie helpers
- `lib/session.ts`: request/session user resolution
- `lib/date.ts`: dateKey/week utilities
- `lib/types.ts`: document and DTO interfaces
- `lib/serialize.ts`: Mongo doc -> API DTO serialization
- `lib/api.ts`: shared API helpers

### Utility scripts

- `scripts/seed-sample-users.cjs`: seed sample users/tasks/reflections/projects

---

## 4) Environment Variables

Reference: `.env.example`

- `PORT`: app port (local default `8084`)
- `NODE_ENV`: runtime mode
- `MONGODB_URI`: Mongo connection URI
- `MONGODB_DB`: DB name (fallback inferred from URI path, then `kaizennote`)
- `JWT_SECRET`: JWT signing secret
- `JWT_EXPIRES_IN`: token TTL, default `7d`
- `TZ`: default timezone for date key generation, default `Asia/Ho_Chi_Minh`
- `COOKIE_SECURE` (optional): force cookie security
  - `true` => always Secure
  - `false` => never Secure
  - unset => auto detect (localhost/http => not Secure)

---

## 5) Authentication and Session Model

### User model and login

- Username + password credentials.
- Password stored as `passwordHash` (bcrypt, cost 12).
- Register endpoint auto-seeds default activity types for new user.

### Session

- Cookie name: `kaizen_session`.
- JWT payload:
  - `sub`: user id
  - `username`
- Cookie settings:
  - `httpOnly: true`
  - `sameSite: "lax"`
  - `path: "/"`
  - `maxAge: 7 days`
  - `secure`: request-aware (`localhost/http` disabled for Safari/local compatibility)

### Authorization

- Protected routes call `getRequestUser()` from `lib/session.ts`.
- User ownership is enforced by filtering on `userId` in DB queries.

---

## 6) Database Model

### Collections

- `users`
- `activityTypes`
- `projects`
- `tasks`
- `dailyReflections`

### Document shapes

`users`

- `_id: ObjectId`
- `username: string` (unique)
- `passwordHash: string`
- `createdAt: Date`
- `updatedAt: Date`

`activityTypes`

- `_id: ObjectId`
- `userId: ObjectId`
- `name: string`
- `color: string` (hex)
- `createdAt: Date`
- `updatedAt: Date`

`projects`

- `_id: ObjectId`
- `userId: ObjectId`
- `name: string`
- `description?: string`
- `color: string` (hex)
- `createdAt: Date`
- `updatedAt: Date`

`tasks`

- `_id: ObjectId`
- `userId: ObjectId`
- `dateKey: string` (`YYYY-MM-DD`)
- `hour: number` (`0..23`)
- `note: string` (max 300)
- `activityTypeId: ObjectId`
- `projectId?: ObjectId`
- `createdAt: Date`
- `updatedAt: Date`

`dailyReflections`

- `_id: ObjectId`
- `userId: ObjectId`
- `dateKey: string` (`YYYY-MM-DD`)
- `plan: string` (max 2000)
- `result: string` (max 2000)
- `improvement: string` (max 2000)
- `createdAt: Date`
- `updatedAt: Date`

### Indexes (auto ensured in `lib/mongodb.ts`)

- `users`: `{ username: 1 }` unique
- `activityTypes`: `{ userId: 1, name: 1 }` unique
- `projects`: `{ userId: 1, name: 1 }` unique
- `tasks`: `{ userId: 1, dateKey: 1, hour: 1 }` unique
- `tasks`: `{ userId: 1, dateKey: 1 }`
- `dailyReflections`: `{ userId: 1, dateKey: 1 }` unique

---

## 7) API Reference

All responses are JSON.
Protected endpoints require a valid session cookie.

## 7.1 Auth

### `POST /api/auth/register`

- Public
- Body:
  - `username`: 3..32, `[a-zA-Z0-9_]`
  - `password`: min 8
- Returns:
  - `201 { user }` and sets session cookie
- Side effect:
  - Inserts default activity types

### `POST /api/auth/login`

- Public
- Body:
  - `username`
  - `password`
- Returns:
  - `200 { user }` and sets session cookie

### `POST /api/auth/logout`

- Protected or unprotected (safe either way)
- Clears session cookie
- Returns:
  - `200 { success: true }`

### `GET /api/auth/me`

- Protected
- Returns current session user

## 7.2 Activity Types

### `GET /api/activity-types`

- Protected
- Returns:
  - `{ items: ActivityTypeDTO[] }`

### `POST /api/activity-types`

- Protected
- Body:
  - `name`: 1..50
  - `color`: hex
- Returns:
  - `201 { item }`
- Conflict:
  - `409` duplicate name per user

### `PUT /api/activity-types/:id`

- Protected
- Body:
  - `name`, `color`
- Returns:
  - `{ item }`
- Errors:
  - `404` not found
  - `409` duplicate name

### `DELETE /api/activity-types/:id`

- Protected
- Deletes only if no tasks reference it.
- Errors:
  - `409` if tasks exist

## 7.3 Projects

### `GET /api/projects`

- Protected
- Returns:
  - `{ items: ProjectDTO[] }`

### `POST /api/projects`

- Protected
- Body:
  - `name`: 1..80
  - `description`: max 500 optional
  - `color`: hex
- Returns:
  - `201 { item }`
- Conflict:
  - `409` duplicate name per user

### `PUT /api/projects/:id`

- Protected
- Body:
  - `name`, `description`, `color`

### `DELETE /api/projects/:id`

- Protected
- Deletes only if no tasks reference it.
- Errors:
  - `409` if tasks exist

## 7.4 Tasks

### `GET /api/tasks?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`

- Protected
- Returns tasks in date range sorted by date/hour:
  - `{ items: TaskDTO[] }`

### `POST /api/tasks`

- Protected
- Body:
  - `dateKey`: `YYYY-MM-DD`
  - `hour`: `0..23`
  - `note`: optional max 300
  - `activityTypeId`: required ObjectId string
  - `projectId`: optional ObjectId string or null
- Behavior:
  - Upsert by `(userId, dateKey, hour)` (single task per hour slot)
  - Unsets `projectId` when omitted/null
- Returns:
  - `201 { item }`

### `PUT /api/tasks/:id`

- Protected
- Partial updates:
  - `note?`
  - `activityTypeId?`
  - `projectId?` (nullable)

### `DELETE /api/tasks/:id`

- Protected
- Deletes one task

## 7.5 Reflections

### `GET /api/reflections?startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`

- Protected
- Returns:
  - `{ items: ReflectionDTO[] }`

### `POST /api/reflections`

- Protected
- Body:
  - `dateKey`
  - `plan?`, `result?`, `improvement?`
- Upsert by `(userId, dateKey)`

### `GET /api/reflections/:value`

- Protected
- `:value` expected as `YYYY-MM-DD`
- Returns a single reflection for that date

### `DELETE /api/reflections/:value`

- Protected
- `:value` expected as reflection ObjectId
- Deletes reflection by id

## 7.6 Reports

### `GET /api/reports/activity-distribution?startDate=&endDate=`

- Protected
- Aggregates task count (hours) by activity
- Returns name, color, hours, percentage

### `GET /api/reports/project-distribution?startDate=&endDate=`

- Protected
- Aggregates task count by project (includes unassigned)

### `GET /api/reports/weekly-overview?weekStart=YYYY-MM-DD`

- Protected
- `weekStart` optional; normalized to Monday
- Returns:
  - `weekStart`, `weekEnd`
  - `totalHours`
  - `dayTotals[]`
  - `heatmap[]`

### `GET /api/reports/trends?weeks=8`

- Protected
- `weeks` min 1, max 52, default 8
- Returns weekly totals sequence:
  - `[{ weekStart, weekEnd, hours }]`

---

## 8) Frontend: Planner Behavior

Main file: `components/planner/planner-app.tsx`

Tabs:

- Planner
- Dashboard
- Settings
- Profile

Planner grid:

- 7 days x 24 hours.
- Click a cell => select cell (does not auto-open popup).

Keyboard shortcuts in planner grid (popup closed):

- `Arrow` keys: move selected cell.
- Auto-follow scroll keeps selected cell in view.
- `Enter`: open popup editor for selected cell.
- `Delete`/`Backspace`: clear selected cell task (if existing).
- `Cmd/Ctrl + C`: copy selected cell task.
- `Cmd/Ctrl + V`: paste clipboard into selected cell and save immediately.

Popup editor shortcuts (popup open):

- `Enter`: save task.
- `Delete`/`Backspace`: delete selected task.
- `Esc`: close popup.

Empty-cell guard:

- Opening popup on an empty cell and pressing Enter without editing does not create a new task.

Daily Reflection:

- 3-day carousel: yesterday, focus day (center), tomorrow.
- Side cards have reduced emphasis + 3D tilt.
- Navigation: previous day / today / next day.

Dashboard:

- Activity and project distributions.
- Weekly totals chart.
- 8-week trend chart.

Settings:

- Activity CRUD with color.
- Project CRUD with color and description.

Profile:

- Logout.

---

## 9) Serialization and DTO Contract

Mongo `_id` is always serialized to `id` (string) in API responses for:

- ActivityTypeDTO
- ProjectDTO
- TaskDTO
- ReflectionDTO

This avoids exposing raw Mongo objects to the client.

---

## 10) Error Handling and Conventions

Common API error pattern:

- `jsonError(message, status)` returns `{ error: string }`.

Typical statuses:

- `400` bad request / invalid payload
- `401` unauthorized
- `404` not found
- `409` conflict (duplicate name or delete blocked by references)
- `500` unexpected failure

Frontend behavior:

- Unauthorized API calls route user to `/login`.
- Errors shown inline in UI.

---

## 11) Local Development

Install and run:

```bash
npm install
npm run dev
```

Quality checks:

```bash
npm run lint
npm run build
```

Run production mode locally on custom port:

```bash
npm run build
npm run start -- --port 8084
```

---

## 12) Seeding and Test Data

Script:

- `scripts/seed-sample-users.cjs`

What it does:

- Upserts sample users
- Ensures default activities/projects
- Seeds 2 recent weeks of tasks and daily reflections
- Prints summary JSON

Run:

```bash
node scripts/seed-sample-users.cjs
```

---

## 13) Known Design Decisions

- One task per user/date/hour slot (upsert model).
- Date storage uses `dateKey` (`YYYY-MM-DD`) instead of full datetime in task docs.
- Week is Monday-based.
- Reflection GET/DELETE share one dynamic route segment with different semantics:
  - GET by date key
  - DELETE by reflection id

---

## 14) Troubleshooting

### Login fails with `Unable to reach the server`

- Check app logs and ensure `MONGODB_URI` is present in `.env.local`.

### Safari login fails but Chrome works

- Localhost cookie security mismatch was handled in `lib/auth.ts`.
- If stale cookie exists, clear site data for `localhost`.

### Build fails with Mongo env error

- Ensure `.env.local` has `MONGODB_URI`.

